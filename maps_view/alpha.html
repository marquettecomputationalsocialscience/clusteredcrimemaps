<!DOCTYPE html>
<html lang='en'>
	<head>
		<meta charset="utf-8">
		<title>Milwaukee Crime Map</title>
		<script src='../resources/d3/d3.min.js'></script>
		<link rel='stylesheet' href='../resources/billboard/billboard.css'>
		<script src='../resources/billboard/billboard.js'></script>

		<link rel='stylesheet' href="https://www.w3schools.com/w3css/4/w3.css">
		<script src='../resources/cityLimit.js'></script>
		<script src='../resources/zipcodes.js'></script>
		<script src='../resources/turf.min.js'></script>
		<script src='../data/bias_data/bias.js'></script>
		<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
         	<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>

	</head>
<style>
	div.tooltip{
		position:absolute;
		text-align: left;
		width:200px;
		height: 60px;
       		padding: 2px;
        	font: 12px sans-serif;
        	background: lightsteelblue;
        	border: 0px;
        	border-radius: 8px;
        	pointer-events: none;
        	line-height: 40%
    	}
	svg {
		position:absolute;
	}

	.hull {
		stroke: black;
		stroke-width: 2px;
		stroke-linejoin:round;
		opacity: 0.3;
		pointer-events: none;
	}
	.bar {
		fill:steelblue;
	}
</style>
<body>
       <!--expandable sidebar-->
	<div class="w3-sidebar w3-animate-left w3-bar-block w3-dark-grey" style="display:none" id="sidebar">
   	<button class="w3-bar-item w3-red w3-button w3-large"
  onclick="w3_close()">Close &times;</button>

	<h3> Select a number of clusters, a crime type, a distance metric, a month, and a year. </h3>
	<p>Clusters:
	<select id="cluster">
   		 <option value="2">2</option>
   		 <option value="3">3</option>
   		 <option value="4">4</option>
   		 <option value="5">5</option>
   		 <option value="6">6</option>
   		 <option value="7">7</option>
   		 <option value="8">8</option>
   		 <option value="9">9</option>
   		 <option value="10">10</option>
	</select>
	</p>	

	<p>Crime:
		<select id="crime">
			<option value="0">Theft</option>
			<option value="1">Motor Theft</option>
			<option value="2">Simple Assault</option>
			<option value="3">Robbery</option>
		</select>
	</p>

	<p>Distance Metric:
		<select id="distMet">
        		<option value="0">Euclidian</option>
        		<option value="1">Geodesic</option>
        		<option value="2">Manhattan</option>
		</select>
	</p>

	<p>Month:
        	<select id="months">
    			<option value="0">January</option>
    			<option value="1">February</option>
    			<option value="2">March</option>
    			<option value="3">April</option>
    			<option value="4">May</option>
    			<option value="5">June</option>
    			<option value="6">July</option>
    			<option value="7">August</option>
    			<option value="8">September</option>
    			<option value="9">October</option>
    			<option value="10">November</option>
    			<option value="11">December</option>
		</select>
	</p>

<p>Year:
        <select id="year">
    <option value="0">2005</option>
    <option value="1">2006</option>
    <option value="2">2007</option>
    <option value="3">2008</option>
    <option value="4">2009</option>
    <option value="5">2010</option>
    <option value="6">2011</option>
    <option value="7">2012</option>
    <option value="8">2013</option>
    <option value="9">2014</option>
    <option value="10">2015</option>
    <option value="11">2016</option>
	</select>
</p>
</div>

<div>
	<button id="openNav" class="w3-button w3-xlarge" onclick="w3_open()">&#9776;</button>
	<h2>Milwaukee Crime Clusters</h2>
</div>

<div>
	<button id='saveButton'>Save</button>
</div>


<script type='text/javascript'>
//create starting conditions
randomStart()
rename()

//core functionality and svg should go here
//get data

var numFiles = 575;
var crimeTypes = ['mtheft', 'robbery', 'theft', 'assault']
for (i = 2005; i <= 2016 ; i++) { 
    for (j = 1; j <= 12; j++){
	for (k = 0; k < crimeTypes.length; k++){
		month = j + '';
		if (month.length == 1){
			month = '0' + month;
		}
		fileName = '../data/clustered_data/' + i + "_" + month + "_" + crimeTypes[k] + "_clustered.js";
		var jsData = document.createElement('script');
		jsData.setAttribute('src', fileName);
		document.head.appendChild(jsData);
		console.log(fileName);
	}
    }
}





//non core functionalities
		function randomStart(){
			document.getElementById("months").value=Math.floor(Math.random()*12)
		        document.getElementById("year").value=Math.floor(Math.random()*12)
		        document.getElementById("crime").value=Math.floor(Math.random()*4)
		        document.getElementById("distMet").value=Math.floor(Math.random()*3)
		        document.getElementById("cluster").value =Math.floor((Math.random()*9)+2)
            }

		function rename(){
			var crimeSel=document.getElementById('crime')
			var strCrime=crimeSel.options[crimeSel.selectedIndex].text

			var monthSel=document.getElementById('months');
			var strMonth=monthSel.options[monthSel.selectedIndex].text
            
			var yearSel=document.getElementById('year');
			var strYear=yearSel.options[yearSel.selectedIndex].text
			
			d3.select('h2').text(function() {return "Milwaukee "+strCrime +" Map for "+strMonth +" "+strYear});
            };

	//<!-- sidebar functionality from w3schools.com--> 
		function w3_open() {
  		//document.getElementById("main").style.marginLeft = "30%";
  		document.getElementById("sidebar").style.width = "30%";
  		document.getElementById("sidebar").style.display = "block";
  		//document.getElementById("openNav").style.display = 'none';
	}

		function w3_close() {
		  //document.getElementById("main").style.marginLeft = "0%";
		  document.getElementById("sidebar").style.display = "none";
		  document.getElementById("openNav").style.display = "inline-block";
}    

d3.select('#saveButton').on('click', function(){
        var svgString=getSVGString(d3.select('svg').node());
        svgString2Image(svgString,width,height, 'png', save);
        function save(dataBlob, filesize){
                saveAs(dataBlob,'CrimeMap.png')
        }
});
function getSVGString( svgNode ) {
        svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
        var cssStyleText = getCSSStyles( svgNode );
        appendCSS( cssStyleText, svgNode );

        var serializer = new XMLSerializer();
        var svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
        svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

        return svgString;

        function getCSSStyles( parentElement ) {
                var selectorTextArr = [];

                // Add Parent element Id and Classes to the list
                selectorTextArr.push( '#'+parentElement.id );
                for (var c = 0; c < parentElement.classList.length; c++)
                                if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                                        selectorTextArr.push( '.'+parentElement.classList[c] );

                // Add Children element Ids and Classes to the list
                var nodes = parentElement.getElementsByTagName("*");
                for (var i = 0; i < nodes.length; i++) {
                        var id = nodes[i].id;
                        if ( !contains('#'+id, selectorTextArr) )
                                selectorTextArr.push( '#'+id );

                        var classes = nodes[i].classList;
                        for (var c = 0; c < classes.length; c++)
                                if ( !contains('.'+classes[c], selectorTextArr) )
                                        selectorTextArr.push( '.'+classes[c] );
                }

                // Extract CSS Rules
                var extractedCSSText = "";
                for (var i = 0; i < document.styleSheets.length; i++) {
                        var s = document.styleSheets[i];
                        
                        try {
                            if(!s.cssRules) continue;
 } catch( e ) {
                                if(e.name !== 'SecurityError') throw e; // for Firefox
                                continue;
                        }

                        var cssRules = s.cssRules;
                        for (var r = 0; r < cssRules.length; r++) {
                                if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                                        extractedCSSText += cssRules[r].cssText;
                        }
                }
                

                return extractedCSSText;

                function contains(str,arr) {
                        return arr.indexOf( str ) === -1 ? false : true;
                }

        }

        function appendCSS( cssText, element ) {
                var styleElement = document.createElement("style");
                styleElement.setAttribute("type","text/css"); 
                styleElement.innerHTML = cssText;
                var refNode = element.hasChildNodes() ? element.children[0] : null;
                element.insertBefore( styleElement, refNode );
        }
}


	function svgString2Image( svgString, width, height, format, callback ) {
        	var format = format ? format : 'png';

        	var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

        	var canvas = document.createElement("canvas");
        	var context = canvas.getContext("2d");

        	canvas.width = width;
        	canvas.height = height;

        	var image = new Image();
        	image.onload = function() {
                context.clearRect ( 0, 0, width, height );
                context.drawImage(image, 0, 0, width, height);

                canvas.toBlob( function(blob) {
                        var filesize = Math.round( blob.length/1024 ) + ' KB';
			 if ( callback ) callback( blob, filesize );
                });

                
        };

image.src = imgsrc;
};
	</script>
</body>
</html>
